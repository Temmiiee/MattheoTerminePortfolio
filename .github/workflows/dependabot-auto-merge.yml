name: "ü§ñ Dependabot Auto-merge (Production)"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: "Smart Auto-merge"
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
    - name: üîç Analyze Dependabot PR
      id: analyze
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          const title = pr.title.toLowerCase();
          const body = pr.body || '';
          
          // Determine update type and safety
          const isSecurityUpdate = title.includes('security') || body.includes('security');
          const isPatchUpdate = title.includes('patch') || title.match(/bump.*from.*\d+\.\d+\.\d+.*to.*\d+\.\d+\.\d+/);
          const isMinorUpdate = title.includes('minor') || title.match(/bump.*from.*\d+\.\d+\..*to.*\d+\.\d+\./);
          const isMajorUpdate = title.includes('major') || title.match(/bump.*from.*\d+\..*to.*\d+\./);
          
          // Check if it's a dev dependency
          const isDevDependency = title.includes('dev-dependencies') || 
                                 title.match(/@types\/|eslint|prettier|typescript/);
          
          // Auto-merge decision logic
          let shouldAutoMerge = false;
          let reason = '';
          
          if (isSecurityUpdate) {
            shouldAutoMerge = true;
            reason = 'Security update - auto-approved';
          } else if (isPatchUpdate && !isMajorUpdate) {
            shouldAutoMerge = true;
            reason = 'Patch update - safe for auto-merge';
          } else if (isDevDependency && (isPatchUpdate || isMinorUpdate)) {
            shouldAutoMerge = true;
            reason = 'Development dependency - low risk';
          } else if (isMajorUpdate) {
            shouldAutoMerge = false;
            reason = 'Major update - requires manual review';
          } else {
            shouldAutoMerge = false;
            reason = 'Minor/unknown update - manual review recommended';
          }
          
          console.log(`Analysis result: ${shouldAutoMerge ? 'AUTO-MERGE' : 'MANUAL REVIEW'} - ${reason}`);
          
          core.setOutput('should-merge', shouldAutoMerge);
          core.setOutput('reason', reason);
          core.setOutput('is-security', isSecurityUpdate);
          core.setOutput('is-dev-dependency', isDevDependency);

    - name: ‚è≥ Wait for CI checks
      if: steps.analyze.outputs.should-merge == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const maxWaitTime = 10 * 60 * 1000; // 10 minutes
          const checkInterval = 30 * 1000; // 30 seconds
          const startTime = Date.now();
          
          while (Date.now() - startTime < maxWaitTime) {
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            if (pr.mergeable_state === 'clean') {
              console.log('‚úÖ All checks passed - ready for merge');
              return;
            } else if (pr.mergeable_state === 'unstable') {
              console.log('‚ùå CI checks failed - aborting auto-merge');
              core.setFailed('CI checks failed');
              return;
            }
            
            console.log(`‚è≥ Waiting for checks... (${pr.mergeable_state})`);
            await new Promise(resolve => setTimeout(resolve, checkInterval));
          }
          
          console.log('‚è∞ Timeout waiting for checks - manual review required');
          core.setFailed('Timeout waiting for CI checks');

    - name: üöÄ Auto-merge approved updates
      if: steps.analyze.outputs.should-merge == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const reason = '${{ steps.analyze.outputs.reason }}';
          
          try {
            // Add approving review
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: `ü§ñ **Automated approval:** ${reason}\n\n‚úÖ This update has been automatically reviewed and approved for production deployment.`
            });
            
            // Enable auto-merge
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              commit_title: `ü§ñ Auto-merge: ${reason}`,
              merge_method: 'squash'
            });
            
            console.log(`‚úÖ Successfully auto-merged: ${reason}`);
            
          } catch (error) {
            console.log(`‚ùå Auto-merge failed: ${error.message}`);
            core.setFailed(`Auto-merge failed: ${error.message}`);
          }

    - name: üìù Comment on manual review PRs
      if: steps.analyze.outputs.should-merge == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const reason = '${{ steps.analyze.outputs.reason }}';
          
          const body = `## üëÄ Manual Review Required
          
          **Reason:** ${reason}
          
          ### üìã Review Checklist:
          - [ ] Check breaking changes in changelog
          - [ ] Verify compatibility with current codebase
          - [ ] Test locally if significant changes
          - [ ] Confirm no security implications
          
          ### üöÄ If approved:
          - Review and approve this PR
          - Merge when ready for production
          
          ---
          *ü§ñ This PR requires manual review due to update type or scope*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });